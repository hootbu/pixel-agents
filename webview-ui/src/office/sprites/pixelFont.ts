import type { SpriteData } from '../types.js'

export interface PixelFont {
  glyphWidth: number
  glyphHeight: number
  charSpacing: number
  glyphs: Record<string, boolean[][]>
}

// ── 3x5 Font ──────────────────────────────────────────────────
function g3(rows: string[]): boolean[][] {
  return rows.map((r) => r.split('').map((c) => c === '#'))
}

const FONT_3x5: PixelFont = {
  glyphWidth: 3,
  glyphHeight: 5,
  charSpacing: 1,
  glyphs: {
    A: g3(['###', '#.#', '###', '#.#', '#.#']),
    B: g3(['##.', '#.#', '##.', '#.#', '##.']),
    C: g3(['###', '#..', '#..', '#..', '###']),
    D: g3(['##.', '#.#', '#.#', '#.#', '##.']),
    E: g3(['###', '#..', '##.', '#..', '###']),
    F: g3(['###', '#..', '##.', '#..', '#..']),
    G: g3(['###', '#..', '#.#', '#.#', '###']),
    H: g3(['#.#', '#.#', '###', '#.#', '#.#']),
    I: g3(['###', '.#.', '.#.', '.#.', '###']),
    J: g3(['..#', '..#', '..#', '#.#', '###']),
    K: g3(['#.#', '#.#', '##.', '#.#', '#.#']),
    L: g3(['#..', '#..', '#..', '#..', '###']),
    M: g3(['#.#', '###', '###', '#.#', '#.#']),
    N: g3(['#.#', '###', '###', '###', '#.#']),
    O: g3(['###', '#.#', '#.#', '#.#', '###']),
    P: g3(['###', '#.#', '###', '#..', '#..']),
    Q: g3(['###', '#.#', '#.#', '###', '..#']),
    R: g3(['###', '#.#', '##.', '#.#', '#.#']),
    S: g3(['###', '#..', '###', '..#', '###']),
    T: g3(['###', '.#.', '.#.', '.#.', '.#.']),
    U: g3(['#.#', '#.#', '#.#', '#.#', '###']),
    V: g3(['#.#', '#.#', '#.#', '#.#', '.#.']),
    W: g3(['#.#', '#.#', '###', '###', '#.#']),
    X: g3(['#.#', '#.#', '.#.', '#.#', '#.#']),
    Y: g3(['#.#', '#.#', '###', '.#.', '.#.']),
    Z: g3(['###', '..#', '.#.', '#..', '###']),
    '0': g3(['###', '#.#', '#.#', '#.#', '###']),
    '1': g3(['.#.', '##.', '.#.', '.#.', '###']),
    '2': g3(['###', '..#', '###', '#..', '###']),
    '3': g3(['###', '..#', '###', '..#', '###']),
    '4': g3(['#.#', '#.#', '###', '..#', '..#']),
    '5': g3(['###', '#..', '###', '..#', '###']),
    '6': g3(['###', '#..', '###', '#.#', '###']),
    '7': g3(['###', '..#', '..#', '..#', '..#']),
    '8': g3(['###', '#.#', '###', '#.#', '###']),
    '9': g3(['###', '#.#', '###', '..#', '###']),
    ' ': g3(['...', '...', '...', '...', '...']),
    '.': g3(['...', '...', '...', '...', '.#.']),
    ',': g3(['...', '...', '...', '.#.', '#..']),
    '!': g3(['.#.', '.#.', '.#.', '...', '.#.']),
    '?': g3(['###', '..#', '.#.', '...', '.#.']),
    '-': g3(['...', '...', '###', '...', '...']),
    '+': g3(['...', '.#.', '###', '.#.', '...']),
    ':': g3(['...', '.#.', '...', '.#.', '...']),
    '/': g3(['..#', '..#', '.#.', '#..', '#..']),
    '(': g3(['.#.', '#..', '#..', '#..', '.#.']),
    ')': g3(['.#.', '..#', '..#', '..#', '.#.']),
    '#': g3(['.#.', '###', '.#.', '###', '.#.']),
    '@': g3(['###', '#.#', '###', '#..', '###']),
    '<': g3(['..#', '.#.', '#..', '.#.', '..#']),
    '>': g3(['#..', '.#.', '..#', '.#.', '#..']),
    "'": g3(['.#.', '.#.', '...', '...', '...']),
    '"': g3(['#.#', '#.#', '...', '...', '...']),
    '=': g3(['...', '###', '...', '###', '...']),
    '*': g3(['...', '#.#', '.#.', '#.#', '...']),
    '_': g3(['...', '...', '...', '...', '###']),
  },
}

// ── 5x7 Font ──────────────────────────────────────────────────
function g5(rows: string[]): boolean[][] {
  return rows.map((r) => r.split('').map((c) => c === '#'))
}

const FONT_5x7: PixelFont = {
  glyphWidth: 5,
  glyphHeight: 7,
  charSpacing: 1,
  glyphs: {
    A: g5(['.###.', '#...#', '#...#', '#####', '#...#', '#...#', '#...#']),
    B: g5(['####.', '#...#', '#...#', '####.', '#...#', '#...#', '####.']),
    C: g5(['.####', '#....', '#....', '#....', '#....', '#....', '.####']),
    D: g5(['####.', '#...#', '#...#', '#...#', '#...#', '#...#', '####.']),
    E: g5(['#####', '#....', '#....', '###..', '#....', '#....', '#####']),
    F: g5(['#####', '#....', '#....', '###..', '#....', '#....', '#....']),
    G: g5(['.####', '#....', '#....', '#.###', '#...#', '#...#', '.####']),
    H: g5(['#...#', '#...#', '#...#', '#####', '#...#', '#...#', '#...#']),
    I: g5(['#####', '..#..', '..#..', '..#..', '..#..', '..#..', '#####']),
    J: g5(['..###', '...#.', '...#.', '...#.', '...#.', '#..#.', '.##..']),
    K: g5(['#...#', '#..#.', '#.#..', '##...', '#.#..', '#..#.', '#...#']),
    L: g5(['#....', '#....', '#....', '#....', '#....', '#....', '#####']),
    M: g5(['#...#', '##.##', '#.#.#', '#...#', '#...#', '#...#', '#...#']),
    N: g5(['#...#', '##..#', '#.#.#', '#..##', '#...#', '#...#', '#...#']),
    O: g5(['.###.', '#...#', '#...#', '#...#', '#...#', '#...#', '.###.']),
    P: g5(['####.', '#...#', '#...#', '####.', '#....', '#....', '#....']),
    Q: g5(['.###.', '#...#', '#...#', '#...#', '#.#.#', '#..#.', '.##.#']),
    R: g5(['####.', '#...#', '#...#', '####.', '#.#..', '#..#.', '#...#']),
    S: g5(['.####', '#....', '#....', '.###.', '....#', '....#', '####.']),
    T: g5(['#####', '..#..', '..#..', '..#..', '..#..', '..#..', '..#..']),
    U: g5(['#...#', '#...#', '#...#', '#...#', '#...#', '#...#', '.###.']),
    V: g5(['#...#', '#...#', '#...#', '#...#', '.#.#.', '.#.#.', '..#..']),
    W: g5(['#...#', '#...#', '#...#', '#.#.#', '#.#.#', '##.##', '#...#']),
    X: g5(['#...#', '.#.#.', '..#..', '..#..', '..#..', '.#.#.', '#...#']),
    Y: g5(['#...#', '.#.#.', '..#..', '..#..', '..#..', '..#..', '..#..']),
    Z: g5(['#####', '....#', '...#.', '..#..', '.#...', '#....', '#####']),
    '0': g5(['.###.', '#...#', '#..##', '#.#.#', '##..#', '#...#', '.###.']),
    '1': g5(['..#..', '.##..', '..#..', '..#..', '..#..', '..#..', '.###.']),
    '2': g5(['.###.', '#...#', '....#', '..##.', '.#...', '#....', '#####']),
    '3': g5(['.###.', '#...#', '....#', '..##.', '....#', '#...#', '.###.']),
    '4': g5(['...#.', '..##.', '.#.#.', '#..#.', '#####', '...#.', '...#.']),
    '5': g5(['#####', '#....', '####.', '....#', '....#', '#...#', '.###.']),
    '6': g5(['.###.', '#....', '#....', '####.', '#...#', '#...#', '.###.']),
    '7': g5(['#####', '....#', '...#.', '..#..', '.#...', '.#...', '.#...']),
    '8': g5(['.###.', '#...#', '#...#', '.###.', '#...#', '#...#', '.###.']),
    '9': g5(['.###.', '#...#', '#...#', '.####', '....#', '....#', '.###.']),
    ' ': g5(['.....', '.....', '.....', '.....', '.....', '.....', '.....']),
    '.': g5(['.....', '.....', '.....', '.....', '.....', '.....', '..#..']),
    ',': g5(['.....', '.....', '.....', '.....', '.....', '..#..', '.#...']),
    '!': g5(['..#..', '..#..', '..#..', '..#..', '..#..', '.....', '..#..']),
    '?': g5(['.###.', '#...#', '....#', '..##.', '..#..', '.....', '..#..']),
    '-': g5(['.....', '.....', '.....', '#####', '.....', '.....', '.....']),
    '+': g5(['.....', '..#..', '..#..', '#####', '..#..', '..#..', '.....']),
    ':': g5(['.....', '..#..', '.....', '.....', '.....', '..#..', '.....']),
    '/': g5(['....#', '...#.', '..#..', '..#..', '.#...', '#....', '#....']),
    '(': g5(['..#..', '.#...', '#....', '#....', '#....', '.#...', '..#..']),
    ')': g5(['..#..', '...#.', '....#', '....#', '....#', '...#.', '..#..']),
    '#': g5(['.#.#.', '.#.#.', '#####', '.#.#.', '#####', '.#.#.', '.#.#.']),
    '@': g5(['.###.', '#...#', '#.###', '#.#.#', '#.##.', '#....', '.###.']),
    '<': g5(['....#', '...#.', '..#..', '.#...', '..#..', '...#.', '....#']),
    '>': g5(['#....', '.#...', '..#..', '...#.', '..#..', '.#...', '#....']),
    "'": g5(['..#..', '..#..', '.....', '.....', '.....', '.....', '.....']),
    '"': g5(['.#.#.', '.#.#.', '.....', '.....', '.....', '.....', '.....']),
    '=': g5(['.....', '.....', '#####', '.....', '#####', '.....', '.....']),
    '*': g5(['.....', '#.#.#', '.###.', '#####', '.###.', '#.#.#', '.....']),
    '_': g5(['.....', '.....', '.....', '.....', '.....', '.....', '#####']),
  },
}

export const PIXEL_FONTS: Record<string, PixelFont> = {
  '3x5': FONT_3x5,
  '5x7': FONT_5x7,
}

/** Generate a SpriteData for the given text using a pixel font. */
export function generateTextSprite(
  text: string,
  fontKey: string,
  color: string,
  scale: number,
): SpriteData {
  const font = PIXEL_FONTS[fontKey]
  if (!font) return [['']]

  const upper = text.toUpperCase()
  const chars = upper.split('')

  if (chars.length === 0) return [['']]

  // Collect glyphs — unknown chars become filled rectangles
  const glyphs: boolean[][][] = chars.map((ch) => {
    if (font.glyphs[ch]) return font.glyphs[ch]
    // Unknown char: filled rectangle
    const filled: boolean[][] = []
    for (let r = 0; r < font.glyphHeight; r++) {
      filled.push(new Array(font.glyphWidth).fill(true))
    }
    return filled
  })

  // Compute total dimensions in base pixels
  const totalBaseWidth =
    chars.length * font.glyphWidth + (chars.length - 1) * font.charSpacing
  const totalBaseHeight = font.glyphHeight

  // Scale
  const totalWidth = totalBaseWidth * scale
  const totalHeight = totalBaseHeight * scale

  // Build sprite array
  const sprite: string[][] = []
  for (let r = 0; r < totalHeight; r++) {
    sprite.push(new Array(totalWidth).fill(''))
  }

  // Render each glyph
  let xOffset = 0
  for (let gi = 0; gi < glyphs.length; gi++) {
    const glyph = glyphs[gi]
    for (let gr = 0; gr < font.glyphHeight; gr++) {
      for (let gc = 0; gc < font.glyphWidth; gc++) {
        if (!glyph[gr][gc]) continue
        // Fill the scaled pixel block
        for (let sr = 0; sr < scale; sr++) {
          for (let sc = 0; sc < scale; sc++) {
            const px = xOffset + gc * scale + sc
            const py = gr * scale + sr
            if (px < totalWidth && py < totalHeight) {
              sprite[py][px] = color
            }
          }
        }
      }
    }
    xOffset += (font.glyphWidth + font.charSpacing) * scale
  }

  return sprite
}
